<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>نظام ترتيب الجداول</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg bg-primary navbar-dark mb-4">
      <div class="container">
        <a class="navbar-brand fw-bold" href="#">نظام ترتيب الجداول</a>
      </div>
    </nav>

    <main class="container mb-5">
      {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
      <div class="alert-stack">
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="إغلاق"></button>
        </div>
        {% endfor %}
      </div>
      {% endif %}
      {% endwith %}

      <section class="card shadow-sm mb-4">
        <div class="card-header bg-white">
          <h2 class="h5 mb-0">رفع ملف Excel</h2>
        </div>
        <div class="card-body">
          <form action="{{ url_for('upload') }}" method="post" enctype="multipart/form-data" class="row g-3">
            <div class="col-md-8">
              <input type="file" class="form-control" name="excel_file" accept=".xls,.xlsx" required />
            </div>
            <div class="col-md-4">
              <button type="submit" class="btn btn-success w-100">رفع واستيراد البيانات</button>
            </div>
          </form>
          <p class="text-muted small mt-3">
            يجب أن يحتوي الملف على الأعمدة: المدرب / المادة / الساعات المطلوبة، ويمكن إضافة عمود الحصص اليومية (اختياري).
          </p>
        </div>
      </section>

      <section class="card shadow-sm mb-4">
        <div class="card-body d-flex flex-wrap gap-3">
          <form action="{{ url_for('run_auto_schedule') }}" method="post">
            <button type="submit" class="btn btn-primary">
              توليد الجدول تلقائيًا
            </button>
          </form>
          <button
            type="button"
            class="btn btn-outline-dark create-schedule-btn"
            data-bs-toggle="modal"
            data-bs-target="#editScheduleModal"
          >
            إضافة حصة يدوية
          </button>
          <a class="btn btn-outline-success" href="{{ url_for('download_template') }}">
            تحميل قالب Excel
          </a>
          <a class="btn btn-outline-primary" href="{{ url_for('export_schedule') }}">
            تصدير الجدول إلى Excel
          </a>
          <form action="{{ url_for('reset_data') }}" method="post" class="reset-data-form">
            <button type="submit" class="btn btn-outline-danger">
              مسح جميع البيانات
            </button>
          </form>
          <button class="btn btn-outline-secondary" id="toggle-trainers">عرض/إخفاء المدربين</button>
          <button class="btn btn-outline-secondary" id="toggle-subjects">عرض/إخفاء المواد</button>
        </div>
      </section>

      <div class="row g-4" id="data-panels">
        <div class="col-lg-6" id="trainers-panel">
          <div class="card shadow-sm h-100">
            <div class="card-header bg-white">
              <h3 class="h6 mb-0">المدربون</h3>
            </div>
            <div class="table-responsive">
              <table class="table table-striped mb-0">
                <thead>
                  <tr>
                    <th>الاسم</th>
                    <th>الخبرات / المواد</th>
                    <th>النصاب الأسبوعي (ساعة)</th>
                    <th>تنزيل الجدول</th>
                  </tr>
                </thead>
                <tbody>
                  {% if trainers %}
                  {% for trainer in trainers %}
                  <tr>
                    <td>{{ trainer.name }}</td>
                    <td>{{ trainer.experience or '—' }}</td>
                    <td>{{ trainer.weekly_hours or 0 }}</td>
                    <td>
                      <a class="btn btn-sm btn-outline-primary" href="{{ url_for('export_trainer_schedule', trainer_id=trainer.id) }}">
                        تحميل
                      </a>
                    </td>
                  </tr>
                  {% endfor %}
                  {% else %}
                  <tr>
                    <td colspan="4" class="text-center text-muted">لا توجد بيانات مدربين بعد.</td>
                  </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="col-lg-6" id="subjects-panel">
          <div class="card shadow-sm h-100">
            <div class="card-header bg-white">
              <h3 class="h6 mb-0">المواد</h3>
            </div>
            <div class="table-responsive">
              <table class="table table-striped mb-0">
                <thead>
                  <tr>
                    <th>المادة</th>
                    <th>الساعات الأسبوعية</th>
                    <th>الحصص اليومية</th>
                  </tr>
                </thead>
                <tbody>
                  {% if subjects %}
                  {% for subject in subjects %}
                  <tr>
                    <td>{{ subject.name }}</td>
                    <td>{{ subject.hours_per_week or 0 }}</td>
                    <td>
                      <form action="{{ url_for('update_daily_slots', subject_id=subject.id) }}" method="post" class="d-flex gap-2 align-items-center">
                        <input type="number" name="daily_slots" class="form-control form-control-sm" value="{{ subject.daily_slots or 1 }}" min="1" style="max-width: 90px" />
                        <button type="submit" class="btn btn-sm btn-outline-primary">تحديث</button>
                      </form>
                    </td>
                  </tr>
                  {% endfor %}
                  {% else %}
                  <tr>
                    <td colspan="3" class="text-center text-muted">لا توجد مواد مسجلة.</td>
                  </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      {% if conflicts %}
      <section class="card shadow-sm mt-4">
        <div class="card-header bg-white">
          <h2 class="h5 mb-0">التعارضات المكتشفة</h2>
        </div>
        <div class="card-body">
          <div class="alert alert-warning mb-3">
            تم العثور على {{ conflicts|length }} تعارضًا في الجدول. يُرجى تعديل الحصص المتداخلة.
          </div>
          <div class="list-group">
            {% for conflict in conflicts %}
            <div class="list-group-item">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-bold">{{ conflict.type }} - {{ conflict.day }}</div>
                  <div class="small text-muted">
                    {{ conflict.first.subject.name }} مع {{ conflict.first.trainer.name }}
                    <span class="mx-1">|</span>
                    {{ conflict.first.start_time }} - {{ conflict.first.end_time }}
                  </div>
                  <div class="small text-muted">
                    {{ conflict.second.subject.name }} مع {{ conflict.second.trainer.name }}
                    <span class="mx-1">|</span>
                    {{ conflict.second.start_time }} - {{ conflict.second.end_time }}
                  </div>
                </div>
                <button
                  class="btn btn-sm btn-outline-secondary edit-schedule-btn"
                  data-bs-toggle="modal"
                  data-bs-target="#editScheduleModal"
                  data-schedule-id="{{ conflict.first.id }}"
                  data-trainer-id="{{ conflict.first.trainer_id }}"
                  data-subject-id="{{ conflict.first.subject_id }}"
                  data-day="{{ conflict.first.day }}"
                  data-start-slot="{{ conflict.first.start_slot_index }}"
                  data-duration-slots="{{ conflict.first.duration_slots }}"
                  data-section="{{ conflict.first.section or '' }}"
                >
                  تعديل الحصة الأولى
                </button>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </section>
      {% endif %}

      <section class="card shadow-sm mt-4">
        <div class="card-header bg-white">
          <h2 class="h5 mb-0">الجدول الأسبوعي</h2>
        </div>
        <div class="card-body">
          {% if weekly_schedule %}
          <div class="row g-3">
            {% for day in days %}
            <div class="col-md-6 col-lg-4">
              <div class="schedule-column h-100">
                <h4 class="h6">{{ day }}</h4>
                <ul class="list-group">
                  {% if weekly_schedule[day] %}
                  {% for slot in weekly_schedule[day] %}
                  <li class="list-group-item">
                    <div class="d-flex justify-content-between">
                      <span class="fw-bold">{{ slot.subject.name }}</span>
                      <span class="text-muted small">{{ slot.start_time }} - {{ slot.end_time }}</span>
                    </div>
                    <div class="small text-secondary">{{ slot.trainer.name }}</div>
                    {% if slot.section %}
                    <div class="small text-info">الشعبة: {{ slot.section }}</div>
                    {% endif %}
                    <div class="mt-2">
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-secondary edit-schedule-btn"
                        data-bs-toggle="modal"
                        data-bs-target="#editScheduleModal"
                        data-schedule-id="{{ slot.id }}"
                        data-trainer-id="{{ slot.trainer_id }}"
                        data-subject-id="{{ slot.subject_id }}"
                        data-day="{{ slot.day }}"
                        data-start-slot="{{ slot.start_slot_index }}"
                        data-duration-slots="{{ slot.duration_slots }}"
                        data-section="{{ slot.section or '' }}"
                      >
                        تحرير
                      </button>
                    </div>
                  </li>
                  {% endfor %}
                  {% else %}
                  <li class="list-group-item text-muted small">لا توجد حصص.</li>
                  {% endif %}
                </ul>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-muted">لم يتم إنشاء أي جدول بعد.</p>
          {% endif %}
        </div>
      </section>

      <section class="card shadow-sm mt-4">
        <div class="card-header bg-white">
          <h2 class="h5 mb-0">جداول المدربين</h2>
        </div>
        <div class="card-body">
          {% if trainer_schedules %}
          <div class="accordion" id="trainerScheduleAccordion">
            {% for trainer_name, entries in trainer_schedules.items() %}
            <div class="accordion-item">
              <h2 class="accordion-header" id="heading-{{ loop.index }}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ loop.index }}" aria-expanded="false">
                  {{ trainer_name }}
                </button>
              </h2>
              <div id="collapse-{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#trainerScheduleAccordion">
                <div class="accordion-body">
                  {% if entries %}
                  <ul class="list-group">
                    {% for entry in entries %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                      <div>
                        <div class="fw-bold">{{ entry.subject.name }}</div>
                        <div class="text-muted small">{{ entry.day }}</div>
                        {% if entry.section %}
                        <div class="text-info small">الشعبة: {{ entry.section }}</div>
                        {% endif %}
                      </div>
                      <span class="text-secondary small">{{ entry.start_time }} - {{ entry.end_time }}</span>
                    </li>
                    {% endfor %}
                  </ul>
                  {% else %}
                  <p class="text-muted mb-0">لا توجد حصص لهذا المدرب.</p>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-muted mb-0">لم يتم تعيين أي حصص للمدربين بعد.</p>
          {% endif %}
        </div>
      </section>

  <div class="modal fade" id="editScheduleModal" tabindex="-1" aria-hidden="true" data-slot-count="{{ time_slots|length }}" data-create-action="{{ url_for('create_schedule_entry') }}">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">تعديل الحصة</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>
            <form method="post" id="scheduleForm" action="{{ url_for('create_schedule_entry') }}">
              <div class="modal-body">
                <div class="mb-3">
                  <label class="form-label">المادة</label>
                  <select class="form-select" name="subject_id" id="editSubject" required>
                    {% for subject in subjects %}
                    <option value="{{ subject.id }}">{{ subject.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">المدرب</label>
                  <select class="form-select" name="trainer_id" id="editTrainer" required>
                    {% for trainer in trainers %}
                    <option value="{{ trainer.id }}">{{ trainer.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">اليوم</label>
                  <select class="form-select" name="day" id="editDay" required>
                    {% for day in days %}
                    <option value="{{ day }}">{{ day }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="row g-3">
                  <div class="col-md-8">
                    <label class="form-label">وقت البداية</label>
                    <select class="form-select" name="start_slot" id="editStartSlot" required>
                      {% for slot in time_slots %}
                      <option value="{{ loop.index0 }}">{{ slot[0] }} - {{ slot[1] }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">المدة (حصص)</label>
                    <input type="number" class="form-control" name="duration_slots" id="editDuration" min="1" max="{{ time_slots|length }}" value="1" />
                  </div>
                </div>
                <div class="mt-3">
                  <label class="form-label">الشعبة</label>
                  <input type="text" class="form-control" name="section" id="editSection" placeholder="مثال: أ أو شعبة 2" />
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="submit" class="btn btn-primary">حفظ التعديلات</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
  </body>
</html>
